#!/usr/bin/env bash

set -euo pipefail

PLUGINS_DIR="$HOME/.zsh/plugins"

declare -A PLUGINS=(
    ["zsh-nvm"]="https://github.com/lukechilds/zsh-nvm.git"
    ["zsh-autosuggestions"]="https://github.com/zsh-users/zsh-autosuggestions.git"
    ["zsh-history-substring-search"]="https://github.com/zsh-users/zsh-history-substring-search.git"
    ["fast-syntax-highlighting"]="https://github.com/zdharma-continuum/fast-syntax-highlighting.git"
    ["zsh-completions"]="https://github.com/zsh-users/zsh-completions.git"
	["fzf-tab"]="https://github.com/Aloxaf/fzf-tab.git.git"
	["zsh-dot-up"]="https://github.com/toku-sa-n/zsh-dot-up.git"
	["npms"]="https://github.com/torifat/npms.git"
	# ["zsh-better-npm-completion"]="https://github.com/lukechilds/zsh-better-npm-completion.git"
	["zsh-bat"]="https://github.com/fdellwing/zsh-bat.git"
	# ["colorize"]="https://github.com/zpm-zsh/colorize.git"
)

# Color codes for output
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly NC='\033[0m' # No Color

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

ensure_plugins_dir() {
    if [[ ! -d "$PLUGINS_DIR" ]]; then
        log_info "Creating plugins directory: $PLUGINS_DIR"
        mkdir -p "$PLUGINS_DIR"
    fi
}

install_or_update_plugin() {
    local plugin_name="$1"
    local repo_url="$2"
    local plugin_path="$PLUGINS_DIR/$plugin_name"

    if [[ -d "$plugin_path/.git" ]]; then
        log_info "Plugin '$plugin_name' exists. Updating..."
        if git -C "$plugin_path" pull --quiet --ff-only; then
            log_info "✓ Updated $plugin_name"
        else
            log_warn "Failed to update $plugin_name (may have local changes)"
        fi
    elif [[ -d "$plugin_path" ]]; then
        log_warn "Directory '$plugin_path' exists but is not a git repo. Skipping."
    else
        log_info "Installing plugin '$plugin_name'..."
        if git clone --quiet --depth=1 "$repo_url" "$plugin_path"; then
            log_info "✓ Installed $plugin_name"
        else
            log_error "Failed to install $plugin_name"
            return 1
        fi
    fi
}

install_all_plugins() {
    local failed_plugins=()

    for plugin_name in "${!PLUGINS[@]}"; do
        if ! install_or_update_plugin "$plugin_name" "${PLUGINS[$plugin_name]}"; then
            failed_plugins+=("$plugin_name")
        fi
    done

    if [[ ${#failed_plugins[@]} -gt 0 ]]; then
        log_error "Failed to install/update: ${failed_plugins[*]}"
        return 1
    fi
}

main() {
    log_info "Starting zsh plugin installation/update..."
    ensure_plugins_dir
    install_all_plugins
    log_info "Plugin installation complete!"
}

main "$@"
